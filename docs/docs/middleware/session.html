<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>session.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>session.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>A middleware that implements cookie-based sessions using Beaker.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">import</span> <span class="nn">beaker.middleware</span>
<span class="kn">from</span> <span class="nn">pump.util</span> <span class="kn">import</span> <span class="n">wsgi</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <p>Adds a "session" key to the request.  Takes the following options:</p>
<ul>
<li>store:
      One of "memory", "database", "file", "cookie", "dbm", "memcached",
      or "google".  Defaults to "memory".</li>
<li>lock_dir:
      The path to the directory to be used as a lock file.  See
      <a href="http://beaker.groovie.org/glossary.html#term-dog-pile-effect">http://beaker.groovie.org/glossary.html#term-dog-pile-effect</a>.</li>
<li>data_dir:
      The path to the directory where files are stored.  Used for file and
      dbm stores.</li>
<li>url:
      Used for database and memcached stores.  In the former case, this
      should be a SQLAlchemy database string <a href="http://bit.ly/gvzIlw">http://bit.ly/gvzIlw</a>, e.g.
      "sqlite:///tmp/sessions.db".  In the latter case, it should be a
      semicolon-separated list of memcached servers.</li>
<li>auto:
      If False, you will need to call request["session"].save() explicitly
      after modifying request["session"].  Defaults to True.</li>
<li>
<p>cookie:
      A dictionary with the following keys:</p>
<ul>
<li>key:
      The name of the cookie.  Defaults to "pump-session".</li>
<li>
<p>secret:
      A long, randomly-generated string used to ensure session
      integrity.</p>
<ul>
<li>domain:
      The domain the cookie will be set on.  Defaults to the current
      domain.</li>
<li>expires:
      The expiration date of the cookie.  If True, expires when the
      browser closes.  If False, never expires.  If a datetime
      instance, expires at that specific date and time.  If a
      timedelta instance, expires after the given time interval.
      Defaults to False.</li>
<li>secure:
      Whether the session cookie should be marked as secure (for
      SSL).</li>
<li>timeout:
      Seconds after the session was last accessed until it is
      invalidated.  Defaults to never expiring.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This uses Beaker in the background, so you can read
<a href="http://beaker.groovie.org/configuration.html">http://beaker.groovie.org/configuration.html</a> for more details.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">wrap_session</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{}):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p>Guess which language doesn't support recursively merging dictionaries?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>  <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">({</span>
    <span class="s">&quot;store&quot;</span><span class="p">:</span> <span class="s">&quot;memory&quot;</span><span class="p">,</span>
    <span class="s">&quot;auto&quot;</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span> <span class="o">**</span><span class="n">options</span><span class="p">),</span> <span class="n">cookies</span><span class="o">=</span><span class="nb">dict</span><span class="p">({</span>
      <span class="s">&quot;expires&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
      <span class="s">&quot;key&quot;</span><span class="p">:</span> <span class="s">&quot;pump-session&quot;</span><span class="p">,</span>
      <span class="s">&quot;secure&quot;</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span> <span class="o">**</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">,</span> <span class="p">{})))</span>

  <span class="k">for</span> <span class="n">middleware</span> <span class="ow">in</span> <span class="p">[</span><span class="n">wrap_unbeaker</span><span class="p">,</span> <span class="n">wrap_beaker</span><span class="p">(</span><span class="n">options</span><span class="p">)]:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">middleware</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">app</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>A Pump middleware that wraps around Beaker's WSGI middleware.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">wrap_beaker</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">wsgi</span><span class="o">.</span><span class="n">build_middleware</span><span class="p">(</span><span class="n">_beaker_wsgi_middleware</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>Renames the beaker.session key in the request to "session".</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">wrap_unbeaker</span><span class="p">(</span><span class="n">app</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">req</span><span class="p">[</span><span class="s">&quot;session&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;beaker.session&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;beaker.session&quot;</span><span class="p">):</span>
      <span class="k">del</span> <span class="n">req</span><span class="p">[</span><span class="s">&quot;beaker.session&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">app</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">wrapped</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>The WSGI middleware provided by Beaker.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">_beaker_wsgi_middleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">beaker</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">SessionMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">_get_beaker_config</span><span class="p">(</span><span class="n">options</span><span class="p">))</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>Reformat options dictionary to match Beaker's configuration settings.  See
<a href="http://beaker.groovie.org/configuration.html">http://beaker.groovie.org/configuration.html</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_beaker_config</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="s">&quot;session.data_dir&quot;</span><span class="p">:</span>       <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;data_dir&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.lock_dir&quot;</span><span class="p">:</span>       <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;lock_dir&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.type&quot;</span><span class="p">:</span>           <span class="n">_get_beaker_session_type</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;store&quot;</span><span class="p">)),</span>
    <span class="s">&quot;session.url&quot;</span><span class="p">:</span>            <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;url&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.auto&quot;</span><span class="p">:</span>           <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;auto&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.cookie_expires&quot;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;expires&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.cookie_domain&quot;</span><span class="p">:</span>  <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;domain&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.key&quot;</span><span class="p">:</span>            <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;key&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.secret&quot;</span><span class="p">:</span>         <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;secret&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.secure&quot;</span><span class="p">:</span>         <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;secure&quot;</span><span class="p">),</span>
    <span class="s">&quot;session.timeout&quot;</span><span class="p">:</span>        <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">)}</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">_get_beaker_session_type</span><span class="p">(</span><span class="n">store</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="s">&quot;database&quot;</span><span class="p">:</span>  <span class="s">&quot;ext:database&quot;</span><span class="p">,</span>
    <span class="s">&quot;memcached&quot;</span><span class="p">:</span> <span class="s">&quot;ext:memcached&quot;</span><span class="p">,</span>
    <span class="s">&quot;google&quot;</span><span class="p">:</span>    <span class="s">&quot;ext:google&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">store</span><span class="p">)</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
