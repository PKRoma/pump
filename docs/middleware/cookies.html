<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>cookies.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>cookies.py</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>A middleware that adds cookie support.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="kn">from</span> <span class="nn">Cookie</span> <span class="kn">import</span> <span class="n">SimpleCookie</span> <span class="k">as</span> <span class="n">Cookie</span>
<span class="kn">from</span> <span class="nn">pump.util</span> <span class="kn">import</span> <span class="n">codec</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <p>Adds a "cookies" key to the request, which contains a dictionary containing
any cookies sent by the client.  If any new values are found in the
dictionary after your app is called, the new cookies are sent to the client.
The values in the dict will be converted to strings, unless they are
themselves dicts.  In that case, the "value" key will be used as the cookie
value and the other keys will be interpreted as cookie attributes.</p>
<pre><code>request["cookies"] = {"a": {"value": "b", "path": "/"}}
</code></pre>
<p>Note: if a cookie is set and is later deleted from request["cookies"], the
corresponding cookie will not automatically be deleted.  You need to set the
"expires" attribute of the cookie to a time in the past.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">wrap_cookies</span><span class="p">(</span><span class="n">app</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>  <span class="k">def</span> <span class="nf">wrapped_app</span><span class="p">(</span><span class="n">request</span><span class="p">):</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p>Get any cookies from the request.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">req_cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">req_cookies</span><span class="p">:</span>
      <span class="n">req_cookies</span> <span class="o">=</span> <span class="n">_parse_cookies</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">request</span><span class="p">[</span><span class="s">&quot;cookies&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">req_cookies</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>If the app modified request["cookies"], set the new cookies.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre>    <span class="n">updated_cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookies&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cookie_header</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">updated_cookies</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
      <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req_cookies</span> <span class="ow">or</span> <span class="n">req_cookies</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">cookie_header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_format_cookie</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="n">response</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&quot;headers&quot;</span><span class="p">,</span> <span class="p">{})[</span><span class="s">&quot;set_cookie&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cookie_header</span>
    <span class="k">return</span> <span class="n">response</span>
  <span class="k">return</span> <span class="n">wrapped_app</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>Parse the cookies from a request into a dictionary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">_parse_cookies</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
  <span class="n">cookie</span> <span class="o">=</span> <span class="n">Cookie</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s">&quot;headers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cookie&quot;</span><span class="p">))</span>
  <span class="n">parsed</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cookie</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="n">parsed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span>
  <span class="k">return</span> <span class="n">parsed</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>Formats the dict of cookies for the set_cookie header.  If a value is a dict,
its "value" key will be used as the value and the other keys will be
interpreted as cookie attributes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="k">def</span> <span class="nf">_format_cookie</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;value&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">}</span>

  <span class="n">cookie</span> <span class="o">=</span> <span class="n">Cookie</span><span class="p">()</span>
  <span class="n">cookie</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;value&quot;</span><span class="p">]</span>
  <span class="k">del</span> <span class="n">val</span><span class="p">[</span><span class="s">&quot;value&quot;</span><span class="p">]</span>

  <span class="n">morsel</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="n">morsel</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
  <span class="k">return</span> <span class="n">morsel</span><span class="o">.</span><span class="n">OutputString</span><span class="p">()</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
